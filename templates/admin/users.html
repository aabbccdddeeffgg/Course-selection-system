{% extends "admin/base.html" %}
{% block title %}ç”¨æˆ·ç®¡ç†{% endblock %}
{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/users.css') }}">
<div class="el-card">
    <h2>ç”¨æˆ·ç®¡ç†</h2>

    <!-- æ·»åŠ ç”¨æˆ·è¡¨å• -->
    <form id="addUserForm" class="add-form">
        <input type="text" name="user_id" placeholder="ç”¨æˆ·IDï¼ˆä¾‹å¦‚ S1001ï¼‰" required>
        <input type="text" name="username" placeholder="å§“å" value="{{ username }}" required autocomplete="new-password">
        <input type="password" name="password" placeholder="å¯†ç " value="{{ password }}" required autocomplete="new-password">

        <select name="role" required>
            <option value="student">å­¦ç”Ÿ</option>
            <option value="teacher">æ•™å¸ˆ</option>
        </select>
        <!-- å­¦ç”Ÿå’Œæ•™å¸ˆéƒ½éœ€è¦é™¢ç³»å· -->
        <input type="text" name="dept_id" placeholder="é™¢ç³»å·" required>
        <!-- å­¦ç”Ÿéœ€è¦æ€§åˆ«å’Œå¹´é¾„ -->
        <input type="text" name="gender" placeholder="æ€§åˆ«ï¼ˆç”·/å¥³ï¼‰">
        <input type="text" name="age" placeholder="å¹´é¾„">
        <button type="submit">æ·»åŠ ç”¨æˆ·</button>
    </form>

    <!-- ç”¨æˆ·åˆ—è¡¨ï¼ˆä»æ•°æ®åº“æŸ¥è¯¢ï¼‰ -->
    <table class="user-table">
        <thead>
            <tr>
                <th colspan="6">å­¦ç”Ÿä¿¡æ¯</th>
                <th colspan="4">æ•™å¸ˆä¿¡æ¯</th>
            </tr>
            <tr>
                <th>å­¦ç”ŸID</th>
                <th>å§“å</th>
                <th>æ€§åˆ«</th>
                <th>å¹´é¾„</th>
                <th>é™¢ç³»å·</th>
                <th>æ“ä½œ</th>
                <th>æ•™å¸ˆID</th>
                <th>å§“å</th>
                <th>é™¢ç³»å·</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% set student_count = students|length %}
            {% set teacher_count = teachers|length %}
            {% set max_count = student_count if student_count > teacher_count else teacher_count %}
            {% for i in range(max_count) %}
            <tr>
                {% if i < student_count %}
                <td>{{ students[i][0] }}</td>
                <td>{{ students[i][1] }}</td>
                <td>{{ students[i][2] }}</td>
                <td>{{ students[i][3] }}</td>
                <td>{{ students[i][4] }}</td>
                <!-- å­¦ç”Ÿæ“ä½œåˆ— -->
                <td>
                    <form class="delete-form" data-role="student">
                        <input type="hidden" name="user_id" value="{{ students[i][0] }}">
                        <button type="submit" class="delete-btn">ğŸ—‘ï¸ åˆ é™¤</button>
                    </form>
                </td>
                {% else %}
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                {% endif %}
                {% if i < teacher_count %}
                <td>{{ teachers[i][0] }}</td>
                <td>{{ teachers[i][1] }}</td>
                <td>{{ teachers[i][2] }}</td>
                <!-- æ•™å¸ˆæ“ä½œåˆ— -->
                <td>
                    <form class="delete-form" data-role="teacher">
                        <input type="hidden" name="user_id" value="{{ teachers[i][0] }}">
                        <button type="submit" class="delete-btn">ğŸ—‘ï¸ åˆ é™¤</button>
                    </form>
                </td>
                {% else %}
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
<script>
// å¤„ç†åˆ é™¤è¡¨å•æäº¤ï¼ˆå¸¦ç¡®è®¤ï¼‰
document.querySelectorAll('.delete-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // è·å–ç”¨æˆ·ä¿¡æ¯ç”¨äºæç¤º
        const userId = this.querySelector('[name="user_id"]').value;
        const role = this.dataset.role === 'student' ? 'å­¦ç”Ÿ' : 'æ•™å¸ˆ';

        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        if (!confirm(`ç¡®å®šè¦åˆ é™¤${role} ${userId} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
            return;
        }

        const formData = new FormData(this);
        formData.append('role', this.dataset.role);

        fetch("{{ url_for('delete_user') }}", {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // æ·»åŠ åˆ é™¤åŠ¨ç”»æ•ˆæœ
                const row = this.closest('tr');
                row.style.transition = 'all 0.3s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
            alert(data.message);
        });
    });
});
</script>
</div>

<script>
document.getElementById('addUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch("{{ url_for('add_user') }}", {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) location.reload();
    });
});
</script>
{% endblock %}